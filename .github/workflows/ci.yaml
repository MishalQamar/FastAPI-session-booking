name: CI Python Docker Image

# Trigger workflow on pushes to main branch or PRs
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Permissions for pushing Docker images to GitHub Container Registry
permissions:
  contents: read
  packages: write

jobs:
  # -------------------- Docker Stage --------------------
  build-python-ci-image:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    # Only run if Dockerfile changes
    if: contains(github.event.head_commit.message, 'Dockerfile') || github.ref == 'refs/heads/main'

    env:
      DOCKER_DRIVER: overlay2
      DOCKER_TLS_CERTDIR: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: |
          docker build \
            -t ghcr.io/mishalqamar/session-booking:cicd-python3.11-slim \
            ci_cd/python

      - name: Push Docker image
        run: |
          docker push ghcr.io/mishalqamar/session-booking:cicd-python3.11-slim

  # -------------------- Test / Code Quality Stage --------------------
  service-session-booking-code-quality:
    name: Run Code Quality Checks
    runs-on: ubuntu-latest
    needs: build-python-ci-image

    # Only run if any file in the service folder changes
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run code quality and checks in container
        run: |
          docker run --rm \
            --user root \
            -v ${{ github.workspace }}/services/session_booking:/app \
            ghcr.io/mishalqamar/session-booking:cicd-python3.11-slim \
            sh -c "\
              cd /app && \
              uv sync --group dev && \
              uv run flake8 . && \
              uv run black . --check && \
              uv run isort . --check-only --profile black && \
              uv run bandit . && \
              uv run safety check
            "

  tests:
    name: Run Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: build-python-ci-image  # Run after Docker image is ready

    # Only run if main branch or pull request, and files changed in service folder
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'

    defaults:
      run:
        working-directory: services/session_booking

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      # Restore cached virtual environment
      - name: Restore .venv cache
        uses: actions/cache@v4
        with:
          path: services/session_booking/.venv
          key: tests-${{ github.sha }}

      # Install dependencies using uv
      - name: Install dependencies
        run: uv sync --group dev

      # Run tests with pytest
      - name: Run tests
        run: uv run python -m pytest --junitxml=report.xml --cov=./ --cov-report=xml tests/unit tests/integration

      # Upload coverage to Codecov
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      # Upload JUnit test report as artifact
      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: services/session_booking/report.xml
