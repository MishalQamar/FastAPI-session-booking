name: CI Python Docker Image

# Trigger on push to main or PRs targeting main; only when relevant paths change
on:
  push:
    branches:
      - main
    paths:
      - 'ci_cd/python/Dockerfile'
      - 'services/session_booking/**'
  pull_request:
    branches:
      - main
    paths:
      - 'ci_cd/python/Dockerfile'
      - 'services/session_booking/**'

# Permissions for pushing Docker images to GitHub Container Registry
permissions:
  contents: read
  packages: write

jobs:
  # -------------------- Detect which paths changed --------------------
  detect-changes:
    name: Detect changed paths
    runs-on: ubuntu-latest
    outputs:
      dockerfile: ${{ steps.filter.outputs.dockerfile }}
      service: ${{ steps.filter.outputs.service }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            dockerfile:
              - 'ci_cd/python/Dockerfile'
            service:
              - 'services/session_booking/**'

  # -------------------- Docker Stage --------------------
  # Runs only on push to main when Dockerfile changed
  build-python-ci-image:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: detect-changes
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.detect-changes.outputs.dockerfile == 'true'

    env:
      DOCKER_DRIVER: overlay2
      DOCKER_TLS_CERTDIR: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: |
          docker build \
            -t ghcr.io/mishalqamar/session-booking:cicd-python3.11-slim \
            ci_cd/python

      - name: Push Docker image
        run: |
          docker push ghcr.io/mishalqamar/session-booking:cicd-python3.11-slim

  # -------------------- Code Quality --------------------
  # Runs on main or PR when services/session_booking/** changed
  service-session-booking-code-quality:
    name: Run Code Quality Checks
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.service == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pull CI Docker image
        run: docker pull ghcr.io/mishalqamar/session-booking:cicd-python3.11-slim

      - name: Run code quality and checks in container
        run: |
          docker run --rm \
            --user root \
            -v ${{ github.workspace }}/services/session_booking:/app \
            ghcr.io/mishalqamar/session-booking:cicd-python3.11-slim \
            sh -c "\
              cd /app && \
              uv sync --group dev && \
              uv run flake8 . && \
              uv run black . --check && \
              uv run isort . --check-only --profile black && \
              uv run bandit . && \
              uv run safety check
            "

  # -------------------- Tests --------------------
  # Runs on main or PR when services/session_booking/** changed
  tests:
    name: Run Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.service == 'true'

    defaults:
      run:
        working-directory: services/session_booking

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      # Restore cached virtual environment
      - name: Restore .venv cache
        uses: actions/cache@v4
        with:
          path: services/session_booking/.venv
          key: tests-${{ github.sha }}

      # Install dependencies using uv
      - name: Install dependencies
        run: uv sync --group dev

      # Run tests with pytest
      - name: Run tests
        run: uv run python -m pytest --junitxml=report.xml --cov=./ --cov-report=xml tests/unit tests/integration

      # Upload coverage to Codecov
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      # Upload JUnit test report as artifact
      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: services/session_booking/report.xml
